下面提供一个比较全面的流程，涵盖了从组件更新触发、节点更新、属性差异比较到子节点 diff 的全过程。下述流程基于 Vue3 的更新机制，但其中很多基本原理也适用于 Vue2（只是 Vue3 在乱序部分引入了 LIS 优化）。

---

## 1. 触发更新：响应式与组件重新渲染

- **数据变化**  
  当组件内部的响应式数据发生变化时，会触发更新（例如通过 setter 通知订阅者）。

- **组件更新**  
  对应组件会调用其 render 函数生成新的 VNode 树。这个 VNode 树包含了节点（元素或组件）、属性（props、class、style、事件等）和子节点（文本或 VNode 数组）的完整描述。

---

## 2. 进入 Patch 流程：新旧 VNode 对比

- **初步判断**  
  进入 patch 函数后，首先会判断新旧 VNode 是否“相同”（通常通过比较 tag（或组件类型）、key、isComment、数据是否定义等条件）。
    - **如果不同**，则直接销毁旧节点并创建新节点。
    - **如果相同**，则进入进一步的“精细化”比较。

- **组件 vs 元素**
    - 如果 VNode 表示的是一个组件（即构造函数或组件选项），那么 patch 流程会进入组件更新分支：
        - 检查已有的组件实例，如果存在则更新 props 并调用组件内部的 render 方法生成新的子树，然后递归进入 patch。
        - 如果不存在，则创建组件实例，并进行初次挂载。
    - 如果 VNode 表示的是普通 DOM 元素，则走元素的更新逻辑。

---

## 3. 节点更新（对于普通 DOM 元素）

### 3.1 节点替换判断

- **判断节点类型**  
  如果新旧节点的 tag 或 key 不同，认为节点不再相同，则直接调用创建新节点的逻辑并替换整个 DOM 元素。

### 3.2 更新属性（属性 / 组件数据）

- **属性比较**  
  Vue 会对比旧 VNode 的 data（包括 attrs、class、style、事件等）和新 VNode 的 data：
    - 对于相同属性且值未变化的不做处理。
    - 对于发生变化的属性，会调用相应的 DOM API 更新，比如修改元素的 class、style、设置或移除属性。
    - 这部分通常在一个叫 patchProps（或 updateProps）的函数中处理。

### 3.3 更新子节点

- **文本节点 vs 数组**
    - 如果旧节点和新节点均为文本节点，则直接比较文本内容，若不同则更新文本。
    - 如果存在子节点数组，则进入子节点 diff 流程。

---

## 4. 子节点 Diff 流程

假设同一父元素下的子节点分别构成旧 children 数组（c1）和新 children 数组（c2），diff 流程通常分为以下几个阶段：

### 4.1 头部同步（Sync from Start）

- 从前向后逐个对比新旧子节点，直到遇到第一个不同的节点为止。
- 对于相同节点，递归调用 patch 更新并将指针向后移动。

### 4.2 尾部同步（Sync from End）

- 从后向前逐个对比新旧子节点，直到遇到不同节点为止。
- 对于相同节点，递归 patch 后将尾部指针向前移动。

### 4.3 中间部分 Diff：乱序、移动与插入

- **情况分析**  
  当头尾同步完成后，新旧数组中间部分可能存在：
    - 有节点在旧数组中不存在（需要创建插入）
    - 有节点在新数组中不存在（需要删除旧节点）
    - 有节点存在但顺序发生变化（需要移动）。

- **建立映射表**  
  为新数组中剩余部分（下标范围 s2 到 e2）建立 key 到索引的映射，便于快速查找。

- **构造索引映射数组**  
  遍历旧数组剩余部分（下标 s1 到 e1），对于每个旧节点：
    - 若能在映射表中找到匹配的 key，则记录新数组中的索引（通常存入 newIndexToOldIndexMap 数组，未匹配到则记录 0）。
    - 同时对已匹配的节点调用 patch 更新。

- **利用最长递增子序列 (LIS)**  
  对 newIndexToOldIndexMap 应用 LIS 算法，找出那些处于正确顺序（即无需移动）的节点。
    - 对于不在 LIS 内的节点，需要通过 DOM 插入（通常 hostInsert 或 insertBefore）将其移动到正确位置。
    - 对于新数组中找不到匹配的节点，则调用 createElm 创建新的 DOM 元素。

- **删除未匹配旧节点**  
  旧数组中未被匹配到的新节点的部分，则需要调用删除操作，将这些旧节点从 DOM 中移除。

---

